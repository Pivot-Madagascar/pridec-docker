name: pridec

# NOTE: because forecsat relies on fetch, these should always be run via `docker compose run` to
# launch a specific service and not the whole workflow at once

services:
  fetch:
    build:
      context: ./fetch
      dockerfile: Dockerfile
    volumes:
     - type: bind
       source: ${HOST_PWD}/input
       target: /app/input
       bind:
          create_host_path: false
       read_only: false
    #specify new DISEASE_CODE env variable via `DISEASE_CODE=new_value docker compose run --rm fetch`
    #env_file:
    #- .env
    environment:
      DHIS2_PRIDEC_URL: "http://44.218.51.103:8080/"
      DHIS2_TOKEN: "${DHIS2_TOKEN}"
      PARENT_OU: "VtP4BdCeXIo"
      DISEASE_CODE: "${DISEASE_CODE}"

  forecast:
    build: 
      context: ./forecast
      dockerfile: Dockerfile
    volumes:
     - type: bind
       source: ${HOST_PWD}/input
       target: /app/input
       bind:
          create_host_path: false
       read_only: true
     - type: bind
       source: ${HOST_PWD}/output
       target: /app/output
       bind:
          create_host_path: false
       read_only: false
    #commands can be overridden when using docker compose run (not up)
    command: --config "input/config.json"

    #3rd service is POST, to post the predictions to a pride-c instance. TO DO
